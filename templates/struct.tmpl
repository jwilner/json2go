{{/* gotype: github.com/jwilner/jsonschema2go.structPlanContext */}}
{{ if .Comment -}}
// {{ .Comment }}
{{ end -}}
{{ if .ID -}}
// generated from {{ .ID }}
{{ end -}}
type {{ .Type.Name }} struct {
{{ range .Fields -}}
	{{ .Name }} {{ if .Type.Pointer -}}*{{ end -}}{{ $.QualName .Type }} {{ if .Tag }}`{{ .Tag }}`{{ end }}
{{ end }}
}

{{ if .ValidateInitialize }}
var (
{{ range $Field := .Fields -}}
{{ range $Field.Validators -}}
	{{ .VarExpr (.NameSpace $.Type.Name $Field.Name) }}
{{ end -}}
{{ end -}}
)
{{ end -}}

func (m *{{ $.Type.Name }}) Validate() error {
{{ range .Fields -}}
{{ if $.Required .JSONName -}}
	if !m.{{ .Name }}.Set {
		return &{{ $.Type.Name }}ValidationError{
			errType: "required",
			jsonField: "{{ .JSONName }}",
			field: "{{ .Name }}",
			message: "field required",
		}
	}
{{ end -}}
{{ end -}}
{{ range $Field := .Fields -}}
{{ range $Field.Validators -}}
{{ if eq .Name "subschema" -}}
    if err := m.{{ $Field.Name }}.Validate(); err != nil {
        return err
	}
{{ else -}}
    if {{ if not ($.Required $Field.JSONName) -}}m.{{ $Field.Name }}.Set &&{{ end -}}{{ .TestExpr (.NameSpace $.Type.Name $Field.Name) (printf "m.%s%s" $Field.Name $Field.Type.ValPath) }} {
		return &{{ $.Type.Name }}ValidationError{
    		errType: "{{ .Name }}",
			jsonField: "{{ $Field.JSONName }}",
			field: "{{ $Field.Name }}",
			message: fmt.Sprintf({{ .Sprintf (.NameSpace $.Type.Name $Field.Name) (printf "m.%s%s" $Field.Name $Field.Type.ValPath) }}),
		}
	}
{{ end -}}
{{ end -}}
{{ end -}}
	return nil
}

{{ range $t := .Traits -}}
{{ if eq .Template "boxed.tmpl" }}
func (m *{{ $.Type.Name }}) MarshalJSON() ([]byte, error) {
    inner := struct {
{{ range $.Fields -}}
{{ if eq .Type.GoPath "github.com/jwilner/jsonschema2go/boxed" -}}
		{{ .Name }} *{{ $t.Primitive .Type }} `json:"{{ .JSONName }},omitempty"`
{{ else -}}
		{{ .Name }} {{ $.QualName .Type }} `json:"{{ .JSONName }},omitempty"`
{{ end -}}
{{ end -}}
	} {
{{ range $.Fields -}}
{{ if ne .Type.GoPath "github.com/jwilner/jsonschema2go/boxed" -}}
		{{ .FieldReference }}: m.{{ .FieldReference }},
{{ end -}}
{{ end -}}
	}
{{ range $.Fields -}}
{{ if eq .Type.GoPath "github.com/jwilner/jsonschema2go/boxed" -}}
    if m.{{ .Name }}.Set {
        inner.{{ .Name }} = &m.{{ .Name }}{{ .Type.ValPath }}
	}
{{ end -}}
{{ end -}}
	return json.Marshal(inner)
}

{{ else if eq .Template "discriminator.tmpl" }}
func (m *{{ $.Type.Name }}) UnmarshalJSON(data []byte) error {
	var discrim struct {
    {{ with .StructField -}}
        {{ .Name }} {{ if .Type.Pointer -}}*{{ end -}}{{ $.QualName .Type }} {{ if .Tag }}`{{ .Tag }}`{{ end }}
	{{ end }}
	}
	if err := json.Unmarshal(data, &discrim); err != nil {
		return err
	}
	switch discrim.{{ $t.StructField.Name }} {
	{{ range .Cases -}}
	case "{{ .Value }}":
		m.{{ $t.StructField.Name }} = new({{ $.QualName .TypeInfo }})
	{{ end -}}
    {{ with .Default -}}
	default:
        m.{{ $t.StructField.Name }} = new({{ $.QualName .TypeInfo }})
	{{ else -}}
	default:
		return fmt.Errorf("unknown discriminator: %v", discrim.{{ $t.StructField.Name }})
	{{ end -}}
	}
	return json.Unmarshal(data, m.{{ .StructField.Name }})
}

func (m *{{ $.Type.Name }}) MarshalJSON() ([]byte, error) {
	return json.Marshal(m.{{ .StructField.Name }})
}
{{ end }}
{{ end }}

type {{ .Type.Name }}ValidationError struct {
	errType, jsonField, field, message string
}

func (e *{{ .Type.Name }}ValidationError) ErrType() string {
	return e.errType
}

func (e *{{ .Type.Name }}ValidationError) JSONField() string {
	return e.jsonField
}

func (e *{{ .Type.Name }}ValidationError) Field() string {
	return e.field
}

func (e *{{ .Type.Name }}ValidationError) Message() string {
	return e.message
}

func (e *{{ .Type.Name }}ValidationError) Error() string {
	return fmt.Sprintf("%v: %v", e.field, e.message)
}

